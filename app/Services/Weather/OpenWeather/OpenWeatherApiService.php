<?php

namespace App\Services\Weather\OpenWeather;

use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Http;

class OpenWeatherApiService
{

    /**
     * @var string
     */
    private string $baseUrl;

    /**
     * @var array
     */
    private array $requestData;

    /**
     * @var mixed
     */
    private mixed $responseData;

    public function __construct($endpoint, $requestData)
    {

        $this->requestData = $requestData;
        $this->baseUrl = $endpoint;
        $this->requestData['appid'] = config('services.openweather.api_key');
    }

    public function handle()
    {
        return $this->call();
    }

    public function call()
    {
        $this->log('REQ_URL: ' . $this->baseUrl);
        $this->log('REQ_PAY: ', $this->requestData);

        try {
            // $mock = '{"cod":"200","message":0,"cnt":40,"list":[{"dt":1696086000,"main":{"temp":299.21,"feels_like":299.21,"temp_min":299.21,"temp_max":299.35,"pressure":1011,"sea_level":1011,"grnd_level":1011,"humidity":85,"temp_kf":-0.14},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":91},"wind":{"speed":4.4,"deg":244,"gust":6.74},"visibility":10000,"pop":0.94,"rain":{"3h":4.48},"sys":{"pod":"n"},"dt_txt":"2023-09-30 15:00:00"},{"dt":1696096800,"main":{"temp":299.01,"feels_like":299.9,"temp_min":298.95,"temp_max":299.01,"pressure":1011,"sea_level":1011,"grnd_level":1011,"humidity":86,"temp_kf":0.06},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":85},"wind":{"speed":3.39,"deg":244,"gust":4.64},"visibility":6205,"pop":0.94,"rain":{"3h":4.93},"sys":{"pod":"n"},"dt_txt":"2023-09-30 18:00:00"},{"dt":1696107600,"main":{"temp":298.94,"feels_like":299.82,"temp_min":298.94,"temp_max":298.94,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":98},"wind":{"speed":4.17,"deg":248,"gust":5.12},"visibility":10000,"pop":0.86,"rain":{"3h":5.54},"sys":{"pod":"n"},"dt_txt":"2023-09-30 21:00:00"},{"dt":1696118400,"main":{"temp":298.77,"feels_like":299.61,"temp_min":298.77,"temp_max":298.77,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":85,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":98},"wind":{"speed":2.74,"deg":244,"gust":4.05},"visibility":10000,"pop":0.96,"rain":{"3h":4.82},"sys":{"pod":"n"},"dt_txt":"2023-10-01 00:00:00"},{"dt":1696129200,"main":{"temp":300.11,"feels_like":303.08,"temp_min":300.11,"temp_max":300.11,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":83,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":86},"wind":{"speed":3.36,"deg":249,"gust":5.23},"visibility":6538,"pop":0.88,"rain":{"3h":5.4},"sys":{"pod":"d"},"dt_txt":"2023-10-01 03:00:00"},{"dt":1696140000,"main":{"temp":300.29,"feels_like":303.62,"temp_min":300.29,"temp_max":300.29,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":84,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":87},"wind":{"speed":4.55,"deg":252,"gust":5.86},"visibility":8455,"pop":0.96,"rain":{"3h":5.21},"sys":{"pod":"d"},"dt_txt":"2023-10-01 06:00:00"},{"dt":1696150800,"main":{"temp":300.59,"feels_like":304.14,"temp_min":300.59,"temp_max":300.59,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":82,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":90},"wind":{"speed":5.06,"deg":246,"gust":6.44},"visibility":10000,"pop":1,"rain":{"3h":4.69},"sys":{"pod":"d"},"dt_txt":"2023-10-01 09:00:00"},{"dt":1696161600,"main":{"temp":299.77,"feels_like":299.77,"temp_min":299.77,"temp_max":299.77,"pressure":1010,"sea_level":1010,"grnd_level":1010,"humidity":84,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":95},"wind":{"speed":4.14,"deg":248,"gust":5.99},"visibility":8576,"pop":1,"rain":{"3h":4.2},"sys":{"pod":"d"},"dt_txt":"2023-10-01 12:00:00"},{"dt":1696172400,"main":{"temp":299.13,"feels_like":299.13,"temp_min":299.13,"temp_max":299.13,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":87},"wind":{"speed":5,"deg":249,"gust":7.63},"visibility":7778,"pop":1,"rain":{"3h":4.37},"sys":{"pod":"n"},"dt_txt":"2023-10-01 15:00:00"},{"dt":1696183200,"main":{"temp":299.04,"feels_like":299.93,"temp_min":299.04,"temp_max":299.04,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":92},"wind":{"speed":3.94,"deg":256,"gust":4.98},"visibility":10000,"pop":1,"rain":{"3h":3.66},"sys":{"pod":"n"},"dt_txt":"2023-10-01 18:00:00"},{"dt":1696194000,"main":{"temp":298.53,"feels_like":299.37,"temp_min":298.53,"temp_max":298.53,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":100},"wind":{"speed":2.45,"deg":272,"gust":4.09},"visibility":8110,"pop":0.83,"rain":{"3h":3.62},"sys":{"pod":"n"},"dt_txt":"2023-10-01 21:00:00"},{"dt":1696204800,"main":{"temp":298.29,"feels_like":299.11,"temp_min":298.29,"temp_max":298.29,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":100},"wind":{"speed":1.77,"deg":280,"gust":3.84},"visibility":10000,"pop":0.77,"rain":{"3h":3.81},"sys":{"pod":"n"},"dt_txt":"2023-10-02 00:00:00"},{"dt":1696215600,"main":{"temp":299.36,"feels_like":299.36,"temp_min":299.36,"temp_max":299.36,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":84,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":1.69,"deg":269,"gust":3.37},"visibility":8806,"pop":0.77,"rain":{"3h":4.12},"sys":{"pod":"d"},"dt_txt":"2023-10-02 03:00:00"},{"dt":1696226400,"main":{"temp":300.7,"feels_like":304.28,"temp_min":300.7,"temp_max":300.7,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":81,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":5.24,"deg":254,"gust":6.19},"visibility":10000,"pop":0.97,"rain":{"3h":5.4},"sys":{"pod":"d"},"dt_txt":"2023-10-02 06:00:00"},{"dt":1696237200,"main":{"temp":300.26,"feels_like":303.44,"temp_min":300.26,"temp_max":300.26,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":83,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":99},"wind":{"speed":4.44,"deg":262,"gust":5.43},"visibility":10000,"pop":1,"rain":{"3h":2.84},"sys":{"pod":"d"},"dt_txt":"2023-10-02 09:00:00"},{"dt":1696248000,"main":{"temp":299.69,"feels_like":299.69,"temp_min":299.69,"temp_max":299.69,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":86,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":94},"wind":{"speed":4.03,"deg":258,"gust":5.32},"visibility":10000,"pop":1,"rain":{"3h":2.38},"sys":{"pod":"d"},"dt_txt":"2023-10-02 12:00:00"},{"dt":1696258800,"main":{"temp":299.29,"feels_like":299.29,"temp_min":299.29,"temp_max":299.29,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":86,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":96},"wind":{"speed":4.29,"deg":259,"gust":6},"visibility":10000,"pop":0.97,"rain":{"3h":2.91},"sys":{"pod":"n"},"dt_txt":"2023-10-02 15:00:00"},{"dt":1696269600,"main":{"temp":298.74,"feels_like":299.63,"temp_min":298.74,"temp_max":298.74,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":87,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":86},"wind":{"speed":2.95,"deg":269,"gust":3.59},"visibility":9425,"pop":0.96,"rain":{"3h":3.41},"sys":{"pod":"n"},"dt_txt":"2023-10-02 18:00:00"},{"dt":1696280400,"main":{"temp":298.16,"feels_like":298.99,"temp_min":298.16,"temp_max":298.16,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":87,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":100},"wind":{"speed":1.12,"deg":300,"gust":2.81},"visibility":5202,"pop":0.85,"rain":{"3h":3.13},"sys":{"pod":"n"},"dt_txt":"2023-10-02 21:00:00"},{"dt":1696291200,"main":{"temp":298.2,"feels_like":298.98,"temp_min":298.2,"temp_max":298.2,"pressure":1011,"sea_level":1011,"grnd_level":1011,"humidity":85,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":100},"wind":{"speed":0.43,"deg":281,"gust":2.57},"visibility":4847,"pop":0.81,"rain":{"3h":3.38},"sys":{"pod":"n"},"dt_txt":"2023-10-03 00:00:00"},{"dt":1696302000,"main":{"temp":299.35,"feels_like":299.35,"temp_min":299.35,"temp_max":299.35,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":82,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":0.86,"deg":121,"gust":2.5},"visibility":10000,"pop":0.66,"rain":{"3h":3.03},"sys":{"pod":"d"},"dt_txt":"2023-10-03 03:00:00"},{"dt":1696312800,"main":{"temp":301.32,"feels_like":304.73,"temp_min":301.32,"temp_max":301.32,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":74,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":98},"wind":{"speed":3.67,"deg":249,"gust":4.13},"visibility":10000,"pop":0.86,"rain":{"3h":1.23},"sys":{"pod":"d"},"dt_txt":"2023-10-03 06:00:00"},{"dt":1696323600,"main":{"temp":301.05,"feels_like":304.43,"temp_min":301.05,"temp_max":301.05,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":76,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":4,"deg":245,"gust":4.19},"visibility":10000,"pop":0.99,"rain":{"3h":1.57},"sys":{"pod":"d"},"dt_txt":"2023-10-03 09:00:00"},{"dt":1696334400,"main":{"temp":299.48,"feels_like":299.48,"temp_min":299.48,"temp_max":299.48,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":86,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":2.46,"deg":225,"gust":3.54},"visibility":10000,"pop":1,"rain":{"3h":3.1},"sys":{"pod":"d"},"dt_txt":"2023-10-03 12:00:00"},{"dt":1696345200,"main":{"temp":298.9,"feels_like":299.75,"temp_min":298.9,"temp_max":298.9,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":85,"temp_kf":0},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10n"}],"clouds":{"all":100},"wind":{"speed":2.18,"deg":218,"gust":2.66},"visibility":10000,"pop":0.94,"rain":{"3h":3.63},"sys":{"pod":"n"},"dt_txt":"2023-10-03 15:00:00"},{"dt":1696356000,"main":{"temp":298.42,"feels_like":299.25,"temp_min":298.42,"temp_max":298.42,"pressure":1014,"sea_level":1014,"grnd_level":1013,"humidity":86,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":89},"wind":{"speed":1.09,"deg":166,"gust":1.72},"visibility":10000,"pop":0.94,"rain":{"3h":2.25},"sys":{"pod":"n"},"dt_txt":"2023-10-03 18:00:00"},{"dt":1696366800,"main":{"temp":298.2,"feels_like":298.98,"temp_min":298.2,"temp_max":298.2,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":85,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":74},"wind":{"speed":1.59,"deg":137,"gust":2.18},"visibility":10000,"pop":0.58,"rain":{"3h":1.11},"sys":{"pod":"n"},"dt_txt":"2023-10-03 21:00:00"},{"dt":1696377600,"main":{"temp":297.65,"feels_like":298.45,"temp_min":297.65,"temp_max":297.65,"pressure":1012,"sea_level":1012,"grnd_level":1011,"humidity":88,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":67},"wind":{"speed":2.42,"deg":120,"gust":2.73},"visibility":10000,"pop":0.57,"rain":{"3h":0.11},"sys":{"pod":"n"},"dt_txt":"2023-10-04 00:00:00"},{"dt":1696388400,"main":{"temp":299.11,"feels_like":299.11,"temp_min":299.11,"temp_max":299.11,"pressure":1014,"sea_level":1014,"grnd_level":1013,"humidity":84,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":65},"wind":{"speed":3.42,"deg":128,"gust":3.77},"visibility":10000,"pop":0.26,"sys":{"pod":"d"},"dt_txt":"2023-10-04 03:00:00"},{"dt":1696399200,"main":{"temp":301.43,"feels_like":304.67,"temp_min":301.43,"temp_max":301.43,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":72,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":62},"wind":{"speed":2.78,"deg":203,"gust":3.32},"visibility":10000,"pop":0.56,"rain":{"3h":0.38},"sys":{"pod":"d"},"dt_txt":"2023-10-04 06:00:00"},{"dt":1696410000,"main":{"temp":301.56,"feels_like":304.94,"temp_min":301.56,"temp_max":301.56,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":72,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":73},"wind":{"speed":3.41,"deg":236,"gust":3.82},"visibility":10000,"pop":1,"rain":{"3h":1.16},"sys":{"pod":"d"},"dt_txt":"2023-10-04 09:00:00"},{"dt":1696420800,"main":{"temp":300.44,"feels_like":303.22,"temp_min":300.44,"temp_max":300.44,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":77,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":63},"wind":{"speed":2.69,"deg":218,"gust":3.38},"visibility":10000,"pop":1,"rain":{"3h":0.8},"sys":{"pod":"d"},"dt_txt":"2023-10-04 12:00:00"},{"dt":1696431600,"main":{"temp":299.01,"feels_like":299.87,"temp_min":299.01,"temp_max":299.01,"pressure":1014,"sea_level":1014,"grnd_level":1013,"humidity":85,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":37},"wind":{"speed":2.94,"deg":210,"gust":3.76},"visibility":10000,"pop":0.97,"rain":{"3h":2.36},"sys":{"pod":"n"},"dt_txt":"2023-10-04 15:00:00"},{"dt":1696442400,"main":{"temp":298.74,"feels_like":299.57,"temp_min":298.74,"temp_max":298.74,"pressure":1013,"sea_level":1013,"grnd_level":1013,"humidity":85,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":44},"wind":{"speed":2.55,"deg":203,"gust":3.36},"visibility":10000,"pop":0.93,"rain":{"3h":2.41},"sys":{"pod":"n"},"dt_txt":"2023-10-04 18:00:00"},{"dt":1696453200,"main":{"temp":298.35,"feels_like":299.2,"temp_min":298.35,"temp_max":298.35,"pressure":1011,"sea_level":1011,"grnd_level":1010,"humidity":87,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":74},"wind":{"speed":1.8,"deg":196,"gust":2.86},"visibility":7516,"pop":0.66,"rain":{"3h":2.76},"sys":{"pod":"n"},"dt_txt":"2023-10-04 21:00:00"},{"dt":1696464000,"main":{"temp":298.73,"feels_like":299.54,"temp_min":298.73,"temp_max":298.73,"pressure":1011,"sea_level":1011,"grnd_level":1011,"humidity":84,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":86},"wind":{"speed":0.84,"deg":179,"gust":2.33},"visibility":10000,"pop":0.65,"rain":{"3h":1.86},"sys":{"pod":"n"},"dt_txt":"2023-10-05 00:00:00"},{"dt":1696474800,"main":{"temp":300.12,"feels_like":302.73,"temp_min":300.12,"temp_max":300.12,"pressure":1013,"sea_level":1013,"grnd_level":1013,"humidity":79,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":77},"wind":{"speed":0.35,"deg":288,"gust":2.16},"visibility":10000,"pop":0.24,"rain":{"3h":0.91},"sys":{"pod":"d"},"dt_txt":"2023-10-05 03:00:00"},{"dt":1696485600,"main":{"temp":301.36,"feels_like":304.82,"temp_min":301.36,"temp_max":301.36,"pressure":1013,"sea_level":1013,"grnd_level":1012,"humidity":74,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":61},"wind":{"speed":2.54,"deg":262,"gust":2.89},"visibility":10000,"pop":0.61,"rain":{"3h":1.31},"sys":{"pod":"d"},"dt_txt":"2023-10-05 06:00:00"},{"dt":1696496400,"main":{"temp":301.61,"feels_like":304.89,"temp_min":301.61,"temp_max":301.61,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":71,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":52},"wind":{"speed":3.62,"deg":257,"gust":3.53},"visibility":10000,"pop":0.57,"rain":{"3h":0.35},"sys":{"pod":"d"},"dt_txt":"2023-10-05 09:00:00"},{"dt":1696507200,"main":{"temp":300.73,"feels_like":303.72,"temp_min":300.73,"temp_max":300.73,"pressure":1010,"sea_level":1010,"grnd_level":1009,"humidity":76,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":66},"wind":{"speed":2.89,"deg":290,"gust":3.97},"visibility":10000,"pop":0.49,"sys":{"pod":"d"},"dt_txt":"2023-10-05 12:00:00"}],"city":{"id":1273874,"name":"Kochi","coord":{"lat":9.9312,"lon":76.2673},"country":"IN","population":604696,"timezone":19800,"sunrise":1696034611,"sunset":1696077998}}';
            // $this->responseData = json_decode($mock);

            $response = Http::get($this->baseUrl, $this->requestData)
                ->throw();

            if($response->successful()){
                $this->responseData = $response->object();
                $this->log('Resp: ', $response->json());

            }else{
                $this->log('FSS Response: ' , $response->throw());
                throw new \Exception($response->object()?->message);
            }

            return $this;
        } catch (\Exception $e) {
            $this->log('API_ERR: ' . $e->getMessage());
            throw $e;
        }

        
    }

    /**
     * @param string $message
     * @param array $context
     * 
     * @return void
     */
    public function log(string $message, $context = [])
    {
        if (config('services.openweather.log_api'))
            Log::info($message, $context);
    }

    /**
     * Get the value of responseData
     *
     * @return  mixed
     */ 
    public function getResponseData()
    {
        return $this->responseData;
    }
}
